<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>记一次服务器的维护 - Zee Tsui</title>
  <title>ZC 个人内容记录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/favicon.ico">
  <link rel="canonical" href="/posts/2020/20200129-%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%BB%B4%E6%8A%A4/" />

  
  
  <link rel="stylesheet" href="/css/style.min.c813c458db6847576b9bd786addc081f1f218bc0b99cdfe79f2daf35df2e453a.css">
  

  
    
    <meta property="og:title" content="记一次服务器的维护"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="/posts/2020/20200129-%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%BB%B4%E6%8A%A4/"/>
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@zerostaticio"/>
    <meta name="twitter:creator" content="@zerostaticio"/>
  

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"> 
</head>




<body class='page frame page-blog-single'>
  <div id="menu-main-mobile" class="menu-main-mobile">
    <ul class="menu">
        
        
            
                <li class="menu-item-home">
                    <a href="/">Home</a>
                </li>
            
        
            
                <li class="menu-item-blog">
                    <a href="/posts/">Blog</a>
                </li>
            
        
            
                <li class="menu-item-categories">
                    <a href="/categories/">Categories</a>
                </li>
            
        
            
            <li class="menu-item-gallery">
                <a href="/gallery">Gallery</a>
            </li>
            
        
            
                <li class="menu-item-log">
                    <a href="/log/">Log</a>
                </li>
            
        
            
                <li class="menu-item-about">
                    <a href="/pages/about/">About</a>
                </li>
            
        
    </ul>
</div>
  <div id="wrapper" class="wrapper">
    <div class='header'>
  
  <a></a>
  <div class="menu-main">
    <ul>
      
      
      
      <li class="menu-item-home">
        <a href="/">
          
          <span>Home</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-blog">
        <a href="/posts/">
          
          <span>Blog</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-categories">
        <a href="/categories/">
          
          <span>Categories</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-gallery">
        <a href="/gallery">
          
          <span>Gallery</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-log">
        <a href="/log/">
          
          <span>Log</span>
        </a>
      </li>
      
      
      
      <li class="menu-item-about">
        <a href="/pages/about/">
          
          <span>About</span>
        </a>
      </li>
      
      
    </ul>
  </div>
  <div id="toggle-menu-main-mobile" class="hamburger-trigger">
    <button class="hamburger">Menu</button>
  </div>
</div>
    
  <div class="blog">
    <div class="intro-article">
      <h1>记一次服务器的维护<span class="dot">.</span></h1>
      
    </div>
    <div class="content">
      <p>最近因为某些<strong>不可言说的原因</strong>，我趁着农历春节优惠，用 <strong>8.88 $ / 年</strong>的价格购了一台国外服务器。</p>
<!-- more -->
<p>在搭好了所有环境之后，已经可以正式地部署使用了，于是我开始愉快地玩耍起来。但后来我逐渐发现，在登录服务器的时候，SSH 时 <strong>Authentication 过程</strong>相当地漫长；毕竟服务器地处遥远，我也没当回事。</p>
<p>直到后来服务器密码被改掉了，我才发现原来<strong>服务器被人黑了</strong>。</p>
<h3 id="破解密码">破解密码</h3>
<p>我一开始设置的初始密码为 <code>12345678</code>（当时也不知道网络上坏人竟然这么多），所以也十分容易被暴力破解。</p>
<p>怎么解决呢？难道就这样把自己的服务器拱手让人了吗？不，我赵铁柱是不会这么容易屈服的，于是我很快找到了解决办法。</p>
<p>入手点就在于<strong>服务器的提供商在后台也给我们了一系列的运维选项</strong>，以方便我们做一些服务器以外的操作，如<strong>重装系统</strong>，<strong>更改 IP</strong> 等。我好不容易搭好了环境，不想就这么重装了，所以我打算通过 VNC 来解决。</p>
<blockquote>
<p>VNC 是虚拟网络控制台的缩写。它是一款优秀的远程控制工具软件，由著名的 AT&amp;T 的欧洲研究实验室开发。VNC 是基于 UNIX 和 Linux 操作系统的免费开源软件，远程控制能力强大，高效实用，其性能可以和 Windows 和 MAC 中的任何远程控制软件媲美。</p>
</blockquote>
<p>VNC 的好处在于它会完全显示服务器当前所显示的画面，就相当于是一个<strong>远程的显示器</strong>。所以通过内网的 VNC 连接到服务器，然后点击右上角的按键重启：</p>
<p><img src="https://zeee.cc/pictures/blog/20200129%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%BB%B4%E6%8A%A4/1.jpg" alt=""></p>
<p>然后便是熟悉的启动界面，在 boot 状态下点击 esc 键，打断 GNU GRUB 引导，此时可以对启动项进行更改设置等操作。这个时候的操作 CentOS 6 和 CentOS 7 是<strong>不一样的</strong>，我是 CentOS 7，所以直接进入配置文件，设置为单用户模式，重新引导启动。</p>
<p>此时已经可以进入 root 用户了，然后使用 <code>passwd</code> 命令字改密码即可。</p>
<p>设置了强密码后，SSH 的速度还是很慢，正当我找不到原因时，SSH 连接服务器后系统提示我有 <strong>4000 多次失败的登录</strong>。</p>
<h3 id="还在搞我">还在搞我？</h3>
<p>我用 <code>lastb</code> 命令看了一下，有两个来自<strong>江苏连云港的电信 IP</strong> 一直在试 root 密码暴力破解服务器，大量占用 22 端口的资源导致我连接过程缓慢。</p>
<h3 id="禁它">禁它！</h3>
<p>说干就干，直接通过在 <code>/etc/hosts.deny</code> 里面添加规则：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">all:xxx.xxx.xxx
</span></span></code></pre></div><p>禁用了这两个 IP 访问所有用户的权限，当然也可以通过修改 <code>/etc/hosts.allow</code> 来设置 IP 的白名单，更加安全。在系统中 <code>hosts.allow</code> 的优先级会比 <code>hosts.deny</code> 要高。</p>
<blockquote>
<p>tcp 客户端掌管着所有 IP 与服务器之间的连接。其访问配置文件的顺序是先访问 hosts.deny，然后再访问 hosts.allow，这两个文件中的 hosts.deny 和 hosts.allow 可以任意填写，不一定 hosts.deny 文件才能够写 hosts.deny 的规则。因为 hosts.allow 文件是后访问的，可覆写前面的规则，所以优先级会高。</p>
</blockquote>
<h3 id="还没结束">还没结束&hellip;</h3>
<p>封了之后，果然就没有多的登录失败的记录了，而且 SSH 时候的速度也恢复了正常。</p>
<p>就在这时，又多了几条来自<strong>同一个 IP 的登陆失败记录</strong>，一查发现还是江苏连云港市的 IP。真是<strong>大美江苏出人才，不到黄河心不死</strong>啊。我这样一条条 IP 禁下去也不是办法，成本太高，不如采用白名单制，<strong>只允许我的 IP 访问</strong>。因为我在家和在学校上网使用的是<strong>动态 IPv4</strong> 和 <strong>IPv6</strong>，所以不能用，只能用我<strong>另一台服务器的固定 IP</strong> 作为中间点。</p>
<p>于是我在 <code>hosts.deny</code> 文件用 <code>sshd:ALL:deny</code> 规则<strong>禁止了所有的 sshd 访问</strong>，然后再 <code>hosts.allow</code> 文件里只允许了我的<strong>阿里云服务器</strong>（这是我唯一的一个静态 IP）进行 SSH 连接，最后再在<strong>阿里云服务器用公钥设置了免密登录</strong>。</p>
<h3 id="终于结束了">终于结束了。</h3>
<p>至此，我就完成了所有的维护，并将<strong>服务器防火墙</strong>设到了一定的门槛，彻底地阻止了暴力破解的操作。</p>

    </div>
    
    <link href="https://cdn.bootcss.com/KaTeX/0.10.2/katex.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/KaTeX/0.10.2/katex.min.js"></script>
    <script src="https://cdn.bootcss.com/KaTeX/0.10.2/contrib/auto-render.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
                  delimiters: [
                      {left: "$$", right: "$$", display: true},
                      {left: "$", right: "$", display: false}
                  ]
              });
        });
    </script>
  </div>

    <div class="footer">
  <div class="footer-social">
    <h1></h1>
    <p>Copyright © 2022 All Rights Reserved. Built by Zee with ❤.</p>
  </div>
</div>
  </div>

  

  

  
  <script type="text/javascript" src="/js/bundle.min.5993fcb11c07dea925a3fbd58c03c7f1857197c35fccce3aa963a12c0b3c9960.js"></script>
  

  
  

</body>
</html>